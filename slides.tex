\documentclass[10pt,xcolor=pdftex,dvipsnames,table]{beamer}

\usetheme{Boadilla}
%\useoutertheme[subsection=false]{smoothbars}
\usefonttheme{serif}
\usecolortheme{seagull} % dove fly seagull
\useinnertheme{rounded}
\usepackage{pifont}
\usepackage{time}       % date and time
\usepackage{url}
\usepackage{graphicx}
\usepackage[T1]{fontenc}    % european characters
% \usepackage{pgothic}
\usepackage{yfonts}
% \usepackage{courier}
\usepackage{amssymb,amsmath}  % use mathematical symbols
\usepackage{palatino}      % use palatino as the default font
\usepackage{listings}   % insert python code into presentation
\usepackage{multirow}
\setbeamercovered{transparent}
\setbeamertemplate{itemize subitem}[triangle]
\setbeamertemplate{navigation symbols}{}

\newcommand{\tc}{\textcolor}
\newcommand{\select}{$\leadsto~$}
\newcommand{\fb}{\framebox}
\def\ra{$\rightarrow$\,\,}
\definecolor{cadet}{rgb}{0.33, 0.41, 0.47}
\newcommand{\hi}[1]{{\color{cadet}\textsl{#1}}}
\newcommand{\chacha}[1]{\centering{\scalebox{2}{\fontsize{12pt}{0pt}\normalfont{#1}}}}
\newcommand{\chapter}[1]{\begin{frame}{}\chacha{#1}\end{frame}}
\newcommand{\chapterDouble}[2]{\begin{frame}{}\chacha{#1}\\\medskip\chacha{#2}\end{frame}}
\newcommand{\resetEnv}{
  \colorlet{structure}{mystruct}
  \beamertemplateshadingbackground{blue!5}{gray!10}
  \beamertemplateshadingbackground{white}{white}
}
\usepackage{mathtools}
\usepackage{xcolor}
\usepackage{verbatim}
\usepackage{listings}
\usepackage{keystroke}

\definecolor{byzantium}{rgb}{0.44, 0.16, 0.39}
\definecolor{ferrariRed}{rgb}{1.0, 0.11, 0.0}

% tiny-scriptsize-footnotesize-small-normalsize-large-Large-LARGE-huge-Huge

\begin{document}

\title[Chapel workshop]{\LARGE Parallel programming in Chapel}
\author[]{{\large\sc Alex Razoumov}\\{\small alex.razoumov@westgrid.ca}\\\bigskip {\large\sc Juan
    Zuniga}\\{\small juan.zuniga@usask.ca}}
\date[spring 2018]{}
\institute[]{\includegraphics[width=0.40\columnwidth]{./logos/WG-Logo-Jan16}
  \hspace{.65cm}\includegraphics[width=0.30\columnwidth]{./logos/ccLogo}}

\begin{frame}
  \titlepage
\end{frame}

\newcommand{\tnij}{\ensuremath{T^{(n)}_{i,j}}}

% language syntax and the compiler, the notions of locality and parallelism and how they are orthogonal
% concepts in Chapel

\begin{frame}{Why another language?}{\url{http://chapel.cray.com}}
  \begin{itemize}\setlength{\itemsep}{2mm}
  \item Shared- and distributed-memory parallelism built in
    \item Much higher-level (and much easier to use!) than MPI
    \begin{itemize}\setlength{\itemsep}{0.5mm}
      \item ``Python for parallel programming''
      \item few lines of Chapel code typically replace tens of lines of MPI code
      \item granular (``multi-resolution'') design
      \item everything you can do in MPI, you should be able to do in Chapel
    \end{itemize}    
    \item Focus on performance
    \begin{itemize}\setlength{\itemsep}{0.5mm}
      \item compiled language; simple Chapel codes perform as well as optimized C/C++/F90 code
      \item very complex Chapel codes run at $\sim$70\% performance of a similar well-tuned MPI code (not
      bad, but room to improve)
    \end{itemize}    
    \item Perfect language for learning parallel programming for beginners
    \item Open-source: can compile on all Unix-type platforms, precompiled for MacOS (single-locale),
      Docker image (multi-locale)
    \item \tc{red}{Chicken-and-egg situation: too few people know/use Chapel ~$\Longleftrightarrow$~ too few HPC
      centers install and promote it}
  \end{itemize}
\end{frame}

\begin{frame}{Useful links}
  \begin{itemize}\setlength{\itemsep}{3mm}
    \item Getting started guide for Python programmers
    {\small\url{http://chapel-for-python-programmers.readthedocs.io/basics.html}}
    \item Data parallelism in Chapel \url{http://chapel.cray.com/tutorials/ACCU2017/03-DataPar.pdf}
    \item Short tutorial from David Bunde \url{http://faculty.knox.edu/dbunde/teaching/chapel}
    \item Docs and examples for various Chapel modules in \texttt{\$CHPL\_HOME/modules/}, e.g.,
    \texttt{standard/} or \texttt{dists/}
    \item \url{https://learnxinyminutes.com/docs/chapel}
    \item \url{https://stackoverflow.com/questions/tagged/chapel}
  \end{itemize}
\end{frame}

\begin{frame}{Our workshop}
  \begin{columns}[]
    \column{0.31\textwidth}
    \setbeamercolor{block body}{bg=orange!10,fg=black}
    \begin{block}{}
      \begin{center}
        {\sc \underline{Part 1:} basic language features}
      \end{center}
      {\let\normalsize\footnotesize \normalsize
        \begin{itemize}\setlength{\itemsep}{0.6mm}
        \item running single-locale Chapel codes on Cedar
          {\let\small\scriptsize \small
            \begin{itemize}\setlength{\itemsep}{0.5mm}
            \item interactive jobs vs. batch jobs
          \end{itemize}}
        \item quicky on running Chapel on your laptop
        \item problem description: heat transfer equation
        \item variables
        \item ranges and arrays
        \item conditionals
        \item \tc{Mahogany}{\texttt{for}} loops
        \item config variables
        \item timing code execution
      \end{itemize}}
    \end{block}
    \column{0.31\textwidth}
    \setbeamercolor{block body}{bg=orange!20,fg=black}
    \begin{block}{}
      \begin{center}
        {\sc \underline{Part 2:} Task Parallelism}
      \end{center}
      {\let\normalsize\footnotesize \normalsize
        \begin{itemize}\setlength{\itemsep}{1mm}
        \item parallel concepts
          {\let\small\scriptsize \small
            \begin{itemize}\setlength{\itemsep}{0.5mm}
            \item concurrency vs. true parallelism
            \item concurrency vs. locality
          \end{itemize}}
        \item fire-and-forget tasks
          {\let\small\scriptsize \small
            \begin{itemize}\setlength{\itemsep}{0.5mm}
            \item \tc{Mahogany}{\texttt{begin}} statement
            \item \tc{Mahogany}{\texttt{cobegin}} statement
            \item \tc{Mahogany}{\texttt{coforall}} loops
            \item \tc{Mahogany}{\texttt{forall}} loops
          \end{itemize}}
        \item task synchronization
          {\let\small\scriptsize \small
            \begin{itemize}\setlength{\itemsep}{0.5mm}
            \item \tc{Mahogany}{\texttt{sync}} statement
            \item sync variables
            \item atomic variables
          \end{itemize}}
        \item parallelizing the heat transfer solver
      \end{itemize}}
    \end{block}
    \column{0.31\textwidth}
    \setbeamercolor{block body}{bg=orange!30,fg=black}
    \begin{block}{}
      \begin{center}
        {\sc \underline{Part 3:} Domain Parallelism}
      \end{center}
      {\let\normalsize\footnotesize \normalsize
        \begin{itemize}\setlength{\itemsep}{1mm}
        \item running multi-locale Chapel codes on Cedar
        \item simple multi-locale codes
        \item domains and single-locale data parallelism
        \item distributed domains
        \item heat transfer solver on distributed domains
        \item periodic boundary conditions
        \item writing to files
      \end{itemize}}
    \end{block}
  \end{columns}
\end{frame}

\begin{frame}{Numerical problem}{Heat transfer equation}
  \begin{itemize}\setlength{\itemsep}{3mm}
    \item Simple 2D heat (diffusion) equation
    \[
      {\partial T(x,y,t)\over\partial t}={\partial^2 T\over\partial x^2}+{\partial^2 T\over\partial y^2}
    \]
    {\footnotesize
      \item Discretize the solution $T(x,y,t)\approx T^{(n)}_{i,j}$ with $i=1,...,n$ and $j=1,...,n$
      \item Imagine a metallic plate being constantly heated in one corner, e.g. $T^{(n)}_{1,1}=1$
      \item Everywhere else the initial solution is $T^{(0)}_{i,j}=0$}
    \item Discretize the equation with forward Euler time stepping
    \[
      {T^{(n+1)}_{i,j}-\tnij\over\Delta t}=
      {T^{(n)}_{i+1,j}-2T^{(n)}_{i,j}+T^{(n)}_{i-1,j}\over(\Delta x)^2}+
      {T^{(n)}_{i,j+1}-2T^{(n)}_{i,j}+T^{(n)}_{i,j-1}\over(\Delta y)^2}
    \]
  \end{itemize}
\end{frame}

\begin{frame}{Numerical problem}{Heat transfer equation}
  \begin{itemize}\setlength{\itemsep}{3mm}
    \item For simplicity assume $\Delta x=\Delta y=1$
    \item Use $\Delta t=1/4$ which is the upper limit of numerical stability
    \item The finite difference equation becomes
    \[
      T^{(n+1)}_{i,j} = {1\over4}\left[T^{(n)}_{i+1,j}+T^{(n)}_{i-1,j}+T^{(n)}_{i,j+1}+T^{(n)}_{i,j-1}\right]
    \]
    \item The objective is to find $T_{i,j}$ after a certain number of iterations, or when the system is
      in ``steady'' state
    \item Can increase the number of points in the grid to illustrate the advantage of parallelism
  \end{itemize}
\end{frame}

\begin{frame}{Serial exercise: using {\it procedures} and control flow}{Look up Chapel procedures}
  Write a Chapel code to find the root of the equation $x^5 + 8x^3 - 2x^2 + 5x - 1.2 = 0$ using the bisection
  method in the interval [-1,1]
  \begin{columns}[]
    \column{0.45\textwidth}
    \begin{itemize}\setlength{\itemsep}{3mm}
      \item Calculate the function at the ends and the midpoint of the interval
      \item Depending on the signs of the three computed values, let the midpoint be either the new left
      or the new right end
      \item Repeat until your error is below $\Delta x=10^{-8}$
    \end{itemize}
    \column{0.55\textwidth}
    \includegraphics[width=0.95\columnwidth]{figs/bisection.png}
  \end{columns}
\end{frame}

% forall and coforall in abstract level

% revisiting the notion of locality, where in the hardware the tasks (or the different locales) are
% running, parallel data structures, domain maps

\begin{frame}{Distributed domains}
  \includegraphics[width=1.0\columnwidth]{domains.pdf}
  % domain types \url{http://chapel.cray.com/tutorials/ACCU2017/03-DataPar.pdf}
\end{frame}


% http://chapel.cray.com/docs/1.14/primers/primers/distributions.html
% http://chapel.cray.com/tutorials/ACCU2017/03-DataPar.pdf
% builtin Locales variable
% - for loc in Locales {} followed by on loc {}
% - do something on Locales[1]
% become very proficient with regular domains
% blocks.chpl
% - introduce a block-distributed domain and an array of to of it
% cyclic.chpl
% evolution.chpl
% periodic.chpl
% - exercise: modify evolution.chpl to put in periodic BCs
% - check energy conservation
% - write out each timestep to an ASCII file

% iterators, I/O files, modules and other packages?
% how to call C/C++/Fortran functions from Chapel, especially popular numerical libraries

\end{document}

Use the 2D diffusion problem to show all Chapel features:

part 1:
a. base language: define T as a 2D array, and compute its elements one by one with nested for loops
b. Task parallelism 1: substitute for loops with forall loops.
c. Task parallelism 2: decompose T in sub-matrices and distribute them with a coforall loop

part 2:
d. Data parallelism: work with T as a matrix, explore mapping its domain with different methods.
e. Advanced features: Save data of iterations to file, maybe create a customized iterator for the problem ?
